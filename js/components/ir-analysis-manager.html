<div class="wrapperTitle">
	<i class="fa fa-bolt"></i>Incidence Rate Analysis
</div>
<div data-bind="visible:!loading()">
	<!-- ko if: selectedAnalysis() == null -->
	<span class="pull-right btn btn-sm btn-primary" data-bind="click:$component.newAnalysis">New Analysis</span>
	<div data-bind="eventListener: [{event: 'click', selector: '.linkish', callback: onAnalysisSelected}]">
		<ir-analysis-browser params="analysisList: analysisList"></ir-analysis-browser>
	</div>
	<!-- /ko -->

	<!-- ko if: selectedAnalysis() != null -->
	<div>
		<div class="asset-heading">
			<input type="text" data-bind="textInput: selectedAnalysis().name, css: { emptyInput: !(selectedAnalysis().name() && (selectedAnalysis().name().length > 0)) }"></input>
			<div class="btn-group" role="group">
				<button class="btn btn-sm btn-success" data-bind="click: save, enable: (dirtyFlag().isDirty() && !isRunning()), css: {'disabled': !dirtyFlag().isDirty, 'btn-success': dirtyFlag().isDirty}">Save</button>
				<button class="btn btn-sm btn-primary" data-bind="click: close">Close</button>
				<!-- ko if: selectedAnalysis().id() != null -->
				<button class="btn btn-sm btn-primary" data-bind="click: copy, enable: !dirtyFlag().isDirty()">Copy</button>
				<!-- ko ifnot: isRunning -->
				<button class="btn btn-sm btn-danger" data-bind="click: $component.delete">Delete</button>
				<!-- /ko -->
				<!-- /ko -->
			</div>
		</div>
	
		<ul class="nav nav-tabs">
			<li role="presentation" data-bind="css: { active: $component.tabMode() == 'definition' }, click: function() { $component.tabMode('definition') };">
				<a>Definition</a>
			</li>

			<li role="presentation" data-bind="css: { active: $component.tabMode() == 'conceptsets' }, click: function() { $component.tabMode('conceptsets') };">
				<a>Concept Sets</a>
			</li>

			<li role="presentation" data-bind="css: { active: $component.tabMode() == 'generation' }, click: function() { $component.tabMode('generation') };">
				<a>Generation</a>
			</li>
		</ul>
		<div class="tab-content">
			<div role="tabpanel" data-bind="css: { active: $component.tabMode() == 'definition' }" class="tab-pane">
				<div data-bind="eventListener: { event: 'click', selector: '.conceptset_selector', callback: handleConceptSetSelect}">
					<ir-analysis-editor params="analysis: selectedAnalysis().expression"></ir-analysis-editor>
				</div>
			</div>
			<div role="tabpanel" data-bind="css: { active: $component.tabMode() == 'conceptsets' }" class="tab-pane">
				<div style="padding-bottom: 10px;" class="pull-right">
					<button type="button" class="btn btn-sm btn-success pull-right" data-bind="click:function() { exportConceptSetsCSV(); }, css: {'disabled': dirtyFlag().isDirty, 'btn-success': !dirtyFlag().isDirty()}"><i class="fa fa-download" aria-hidden="true"></i> Export All Concept Sets To CSV</button>
				</div>
				<!-- ko with: selectedAnalysis().expression -->										
					<concept-set-builder params="{conceptSets: ConceptSets, ref: $parent.conceptSetEditor}"></concept-set-builder>
				<!-- /ko -->			
			</div>
			<div role="tabpanel" data-bind="css: { active: $component.tabMode() == 'execution' }" class="tab-pane">
				Execution reports here
			</div>		
		</div>	
	</div>

	<div data-bind="modal: showConceptSetBrowser" class="modal fade" tabindex="-1" role="dialog">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">Select Concept Set...</div>
				<div class="paddedWrapper">
					<cohort-concept-set-browser params="criteriaContext: criteriaContext, cohortConceptSets: selectedAnalysis().expression().ConceptSets, onActionComplete: onConceptSetSelectAction"></cohort-concept-set-browser>
				</div>
			</div>
		</div>
	</div>
	<!-- /ko -->
</div>
<div data-bind="visible:loading()" class="loading">loading</div>
